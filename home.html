<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Tables | MyApp</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

  <!-- Header -->
  <header class="bg-indigo-600 text-white p-4 flex justify-between items-center">
    <h1 class="text-xl font-semibold">My Uploaded Tables</h1>
    <div>
      <button id="uploadBtn" class="bg-white text-indigo-600 px-4 py-2 rounded-lg font-medium hover:bg-gray-200">
        + Upload New File
      </button>
      <a href="auth/login.html" class="bg-white text-indigo-600 px-4 py-2 rounded-lg font-medium hover:bg-gray-200">
        Go To Login
      </a>
    </div>
  </header>

  <!-- Main -->
  <main class="flex-1 p-6">
    <div id="msg" class="text-center text-sm font-medium mb-4"></div>

    <div id="tableList" class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
    </div>
  </main>

  <!-- Upload Modal -->
  <div id="uploadModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-6 rounded-2xl shadow-lg w-full max-w-md">
      <h2 class="text-lg font-semibold mb-4">Upload New File</h2>
      <form id="uploadForm" class="space-y-4">
        <input type="file" name="file" accept=".csv,.xls,.xlsx" required class="block w-full border border-gray-300 rounded-lg p-2">
        <button type="submit" class="w-full bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700">Upload</button>
      </form>
      <button id="closeModal" class="mt-4 text-sm text-gray-600 hover:underline">Cancel</button>
      <div id="uploadMsg" class="mt-3 text-center text-sm font-medium"></div>
    </div>
  </div>

  <script>
    const backend = "http://127.0.0.1:5000/";
    const tableList = document.getElementById("tableList");
    const msg = document.getElementById("msg");
    const uploadBtn = document.getElementById("uploadBtn");
    const uploadModal = document.getElementById("uploadModal");
    const closeModal = document.getElementById("closeModal");
    const uploadForm = document.getElementById("uploadForm");
    const uploadMsg = document.getElementById("uploadMsg");

    const token = localStorage.getItem("token");
    if (!token) window.location.href = "auth/login.html";

    async function fetchTables() {
      msg.textContent = "Loading your tables...";
      try {
        const res = await fetch(backend + "api/user-tables", {
          headers: { Authorization: `Bearer ${token}` },
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || "Failed to load tables");
        msg.textContent = "";
        renderTables(data.tables);
      } catch (err) {
        msg.textContent = "❌ " + err.message;
        msg.className = "text-red-600 font-semibold text-center mb-4";
      }
    }

    function renderTables(tables) {
    if (!tables.length) {
      tableList.innerHTML = `<p class='text-center col-span-full text-gray-500'>No tables uploaded yet.</p>`;
      return;
    }

    tableList.innerHTML = tables.map(t => `
      <div class="bg-white p-4 rounded-xl shadow hover:shadow-md transition">
        <h3 class="text-lg font-semibold text-indigo-700">${t.table_name}</h3>
        <a href="${backend + t.source_file}" 
            class="inline-block mt-1 px-3 py-1 bg-indigo-600 text-white rounded-lg text-sm hover:bg-indigo-700"
            download>
            Download File
        </a>
        <div class="mt-3 text-sm">
          <p><strong>Genetic Algorithm Summary</strong></p>
          <p><strong>Fitness:</strong> ${t.ga_result?.fitness?.toFixed(3) || "—"}</p>
          <p><strong>Selected Features:</strong> ${t.ga_result?.selected_features?.length || 0}</p>
        </div>
        ${t.ga_result ? `<button onclick="viewGAResults(${t.ga_result.id})" 
            class="mt-3 w-full bg-green-600 text-white py-1 rounded-lg hover:bg-green-700 text-sm">
            View GA Results
        </button>` : ""}
      </div>
      `).join("");
    }

    function viewGAResults(gaResultId) {
      localStorage.setItem("gaResultId", gaResultId);
      window.location.href = "ga_results.html";
    }

    uploadBtn.addEventListener("click", () => {
      uploadModal.classList.remove("hidden");
    });

    closeModal.addEventListener("click", () => {
      uploadModal.classList.add("hidden");
      uploadMsg.textContent = "";
      uploadForm.reset();
    });

    uploadForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      uploadMsg.textContent = "Uploading...";
      const formData = new FormData(uploadForm);

      try {
        const res = await fetch(backend + "api/upload/", {
          method: "POST",
          headers: { Authorization: `Bearer ${token}` },
          body: formData,
        });
        const data = await res.json();

        if (res.ok) {
          uploadMsg.textContent = "✅ " + data.message;
          uploadMsg.className = "text-green-600 text-center font-medium mt-3";
          await fetchTables();
          setTimeout(() => {
            uploadModal.classList.add("hidden");
            uploadForm.reset();
          }, 1000);
        } else {
          uploadMsg.textContent = "❌ " + (data.error || "Upload failed");
          uploadMsg.className = "text-red-600 text-center font-medium mt-3";
        }
      } catch {
        uploadMsg.textContent = "❌ Network error";
        uploadMsg.className = "text-red-600 text-center font-medium mt-3";
      }
    });

    fetchTables();
  </script>
</body>
</html>
